{% extends "layout.html" %}

{% block title %}
    {{account.name}}
{% endblock %}
{% block platform %}
    {% if platform != None%}
        {{platform.name}}
    {%else%}
        set platform
    {% endif %}
{% endblock %}

{% block model %}
    {% if model%}
        @{{model.username}}
    {%else%}
       set model
    {% endif %}
{% endblock %}

    {%block main%}
            <div class="main-box">
                <div class="header">
                    <h1>Account details</h1>
                    <div class="action-links scroll">
                        <a href="/accounts" class="eleveted-a">
                            accounts
                        </a>
                        <a href="" class="eleveted-a delete Do-you-want-to-delete-this-account?">
                            delete this account
                        </a>
                        <a href="" class="eleveted-a upload-image">
                            add images
                        </a>
                    </div>
                </div>

                <div class="main-container">
                    {%if action != 'edit-account'%}
                    <div class="holder profile-holder scroll">
                        <div class="profile-card">
                            <div class="profile-image" class="item-header"  
                            style="background: url('{{account.profile_image}}');
                            background-repeat: no-repeat;
                            background-size: cover;
                            background-position:top">
                            </div>
                            <div class="profile-card-details">
                                <h4>
                                    {{account.name}}
                                </h4>
                                <div class="d-status">
                                    <p class="bg-success">Active</p>
                                    {% if account.status != 'VERIFIED' %}
                                        <p class="bg-danger">Not verified</p>
                                    {%else%}
                                    <p class="bg-success">Not verified</p>
                                    {%endif%}

                                    <p class="bg-warning">
                                            {% if account.matches < 1%}
                                            not matched
                                            {%else%}
                                            matched
                                            {%endif%}
                                    </p>
                                </div>
                                <div class="d-items">
                                    <p>
                                        {{account.matches}} matches
                                    </p>
                                    <p>
                                        {{account.swipes}} liked
                                    </p>
                                    <p>
                                        {{account.likes}} likes
                                    </p>
                                    <p>
                                        {{account.messages}} messages
                                    </p>
                                </div>
                            </div>
                        </div>
                        <div class="profile-details">
                            {%if action == 'map'%}
                                <div id="map" class="map p-details-actions"></div>
                                <input id="locInput" value="" style="display: none;" title="none" />
                                <div class="p-details-actions">
                                    <a href="" class="" id="updateButton">
                                        Update location
                                    </a>
                                    <a  href="/account-page?account={{account.id}}&action=edit-account" class="edit-account">
                                        Edit account
                                    </a>
                                    <a href="/account-page?account={{account.id}}" class="upload-account-image">
                                        Account details
                                    </a>
                                </div>
                                <script
                                src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBFhK9-HFdkegWcsmq6ue770uDIlRX5CdI&callback=initMap&v=weekly"
                                defer
                              ></script>
                                <script>
                                    window.onload = function() {
                                        // This code will be executed when the window has finished loading
                                        initMap();
                                    };
                                    function initMap() {
                                        const myLatlng = { lat: -25.363, lng: 131.044 };
                                        const map = new google.maps.Map(document.getElementById("map"), {
                                            zoom: 4,
                                            center: myLatlng,
                                        });
                                        // Create the initial InfoWindow.
                                        let infoWindow = new google.maps.InfoWindow({
                                            content: "Click the map to get Lat/Lng!",
                                            position: myLatlng,
                                        });
                        
                                        infoWindow.open(map);
                                        // Configure the click listener.
                                        map.addListener("click", (mapsMouseEvent) => {
                                            // Close the current InfoWindow.
                                            infoWindow.close();
                                            // Create a new InfoWindow.
                                            const latLng = mapsMouseEvent.latLng;
                                            const latitude = latLng.lat();
                                            const longitude = latLng.lng();
                                            document.getElementById("updateButton").addEventListener("click", function() {
                                                // Call your function here
                                                sendLocationToServer(longitude, latitude);
                                            });
                                                    
                                            // Update the value of the input field
                                            document.getElementById("locInput").value = `${latitude}, ${longitude}`;
                                            infoWindow = new google.maps.InfoWindow({
                                            position: mapsMouseEvent.latLng,
                                            });
                                            infoWindow.setContent(
                                            JSON.stringify(mapsMouseEvent.latLng.toJSON(), null, 2)
                                            );
                                            infoWindow.open(map);
                                        });
                                    }
                                    function sendLocationToServer(longitude, latitude) {                             
                                        const url = `/account-page/map-update`;
                                        const data = {
                                            data: {
                                                long: longitude,
                                                lat: latitude
                                            }
                                        };
                                        
                                        fetch(url, {
                                            method: 'POST',
                                            headers: {
                                                'Content-Type': 'application/json'
                                            },
                                            body: JSON.stringify(data)
                                        })
                                        .then(response => {
                                            if (response.ok) {
                                                console.log('Location data sent successfully');
                                            } else {
                                                console.error('Failed to send location data');
                                            };
                                        })
                                        .catch(error => {
                                            console.error('Error occurred while sending location data:', error);
                                        });
                                    }
                                    window.initMap = initMap;
                                </script>
                            {%else%}
                                <ul class="p-details-items">
                                    <li>
                                        <i class="fa fa-envelope"></i>
                                        {{account.email}}
                                    </li>
                                    {%if account.phone%}
                                        <li>
                                            <i class="fas fa-phone-square"></i>
                                            +1{{account.phone.number}}
                                        </li>
                                    {%endif%}
                                    <li>
                                        <i class="fa fa-venus-mars"></i>
                                        {%if account.gender|lower in ['f','female']%}
                                            Female
                                        {%else%}
                                            Male
                                        {%endif%}
                                    </li>
                                    <li style="display: none;">

                                    </li>
                                </ul>
                                <div class="p-details-bio">
                                    <div class="p-details-bio-item">
                                        <i class="fa fa-map-marker"></i> &nbsp;
                                        {{account.city}}, {{account.country_code}}
                                    </div>
                                    <a href="/account-page?account={{account.id}}&action=map" class="">map</a>
                                </div>
                                    
                                <div class="p-details-bio">
                                    <div class="p-details-bio-item bio-desc scroll">
                                        {{account.profile.bio}}
                                    </div>
                                </div>
                                {%if account.images%}
                                    <ul class="p-details-images" id="profile-images">
                                        {%for image in account.images%}
                                        <li>
                                            <img src="{{image}}" class="clickable-image" accountId="{{account.id}}" alt="">
                                        </li>
                                        {%endfor%}
                                        
                                        <span>
                                            <a href="" class="view-all">
                                                view all
                                            </a>
                                        </span>
                                    </ul>
                                {%endif%}
                                <div class="p-details-actions">
                                    <a href="" class="delete Do-you-want-to-delete-this-account?">
                                        Delete account
                                    </a>
                                    <a href="" class="upload-account-image">
                                        Add images
                                    </a>
                                    <a href="/account-page?account={{account.id}}&action=edit-account" class="edit-account">
                                        Edit Account
                                    </a>
                                    <a href="" class="view-matches m">
                                    View matches
                                    </a>
                                    <a href="" class="view-matches l">
                                        View likes
                                    </a>
                                    <a href="" class="view-matches lm">
                                        View liked me
                                    </a>
                                </div>
                            {%endif%}
                        </div>
                    </div>
                    {%else%}
                    <div class="holder scroll form-holder">
                        <h2>
                            Edit-Account
                        </h2>
                        
                        <form action="" class="op-form edit-account" id="account-form" 
                            data-action="edit-account" data-action-message="Updating account details">
                            <div>
                                <label for="bio">Biography</label>
                                <input type="text" name="bio" id="bio" value="{{account.profile.bio}}">
                            </div>
                            <input type="hidden" id="account-id" name="account-id" value="{{account.id}}">
                            <div>
                                <label for="height">Height</label>
                                <input type="number" name="height" id="height" 
                                    value="{%if account.profile.height != ''%}{{account.profile.height}}{%else%}91{%endif%}" 
                                    min="91" max="220">
                                <h5 class="input-highlight"> 
                                    <i class="fas fas fa-exclamation-circle"></i> 
                                    must be between 91 - 220. e.g 91
                                </h5>
                            </div>
                            {% for key, options in edit_data.items() %}
                                <div>
                                    <label for="{{ key }}">{{ key|capitalize }}:</label>
                                    <select name="{{key}}" id="{{ key }}">
                                        {%if account.profile[key] != ''%}
                                            <option value="{{account.profile[key]}}">{{account.profile[key]}}</option>
                                        {%endif%}
                                        {% for option in options %}
                                        <option value="{{ option }}">{{ option }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            {% endfor %}
                            <input type="submit" name="Submit">
                        </form>
                    </div>
                    {%endif%}
                </div>
            </div>
        <style>
            .p-details-bio {
            display: flex;
            align-items: left;
            justify-content: space-between;
            }

            .p-details-bio > div{
                flex: 70%;
                margin: auto;
            }

            .p-details-bio > a{
                width: fit-content;
                text-align: right;
                font-weight: 500;
                background: #fdf3cd;
                border-radius: 10px;
                padding: 2.5px 10px;
                margin: auto;
            }

            .bio-input {
                flex-grow: 1;
                margin-right: 10px;
            }

            .text-style {
                border: none;
                background-color: transparent;
                padding: 0;
                font-size: inherit;
                font-family: inherit;
                color: inherit;
                outline: none;
            }  
            .map{
                height: 70%;
            }
        
            
        </style>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
        <script>
            $(document).ready(function() {
                // Function to handle the update button click event
                $('#updateButton').click(function() {
                    // Make the input field editable
                    $('#bioInput').removeClass('text-style').removeClass('border-style').prop('readonly', false);
                    // Change the button text and click event
                    $('#updateButton').val('Submit').unbind('click').click(function() {
                        // Get the updated bio from the input field
                        var updatedBio = $('#bioInput').val();
                        // Make a POST request to the update endpoint with the updated bio
                        $.ajax({
                            url: '/update/bio/{{id}}',
                            type: 'POST',
                            contentType: 'application/json',
                            data: JSON.stringify({data: updatedBio}),
                            success: function(response) {
                                // Handle the response
                                console.log(response);
                                // Reload the page
                                location.reload();
                            }
                        });
                    });
                });
            });
            const id ='{{id}}';
        </script>
        <!-- <script>
            $(document).ready(function() {
            // Handle click event on the clickable image
            $('.clickable-image').click(function() {
                // Get the image source and account ID
                var imageSrc = $(this).attr('src');
                var accountId = '{{id}}'; // Replace with the actual account ID
                
                // Show the confirmation window
                var confirmation = confirm('Do you want to delete the image?');
                
                if (confirmation) {
                    // Delete button clicked, send delete request
                    $.ajax({
                        url: '/delete-profile-image',
                        type: 'DELETE',
                        data: {
                            data: imageSrc,
                            id: accountId
                        },
                        success: function(response) {
                            // Handle the delete response
                            console.log(response);
                            // Reload the page or perform any other necessary actions
                            location.reload();
                        }
                    });
                }
            });
        });
        </script> -->
        {%if matches%}
            <script>
                const _matches ='{{matches | tojson | safe}}';
            </script>
        {%endif%}
    {%endblock%}